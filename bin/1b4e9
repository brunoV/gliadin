#!/usr/bin/env perl

BEGIN {
    use FindBin qw( $Bin );
    use lib "$Bin/../lib";
}

use Modern::Perl;
use Getopt::Long;
use Pod::Usage;

my ( $db_in_filename, $db_out_filename, $help );

GetOptions(
    "db=s"       => \$db_in_filename,
    "output=s"   => \$db_out_filename,
    'help|?'     => \$help
) or pod2usage(2);

pod2usage(2) if ($help or not $db_in_filename);

use Gliadin::Schema;

my $db_in = Gliadin::Schema->connect("dbi:SQLite:$db_in_filename");

my $db_out;

if ( $db_out_filename ) {
    $db_out = Gliadin::Schema->connect("dbi:SQLite:$db_out_filename");
    $db_out->deploy;
}

my $prs = $db_in->resultset('Peptides');

#my $gli9      = $prs->of_type('Gli#9');
#my $not_gli33 = $prs->not_of_type('Gli#33');
my $alpha     = $prs->of_type('alpha gliadin');
my $beta      = $prs->of_type('beta gliadin');
my $gamma     = $prs->of_type('gamma gliadin');
my $omega     = $prs->of_type('omega gliadin');
my $restof_g  = $prs->of_type('gliadin');
my $secalin   = $prs->of_type('secalin');
my $hordein   = $prs->of_type('hordein');
my $not_oat   = $prs->not_of_species('oat');
#my $not_glutenin   = $prs->not_of_type('glutenin');

my $result = $alpha->union($beta);
$result = $result->union($gamma);
$result = $result->union($omega);
$result = $result->union($restof_g);

foreach my $set ($secalin, $hordein, $not_oat) {
    $result = $result->intersection($set);
}

$result = $result->search( undef, { distinct => 1 } );

$db_out->insert_peptide_rs($result) unless ( not $db_out );

log_peptide_rs($result);

say $result->count;

sub log_peptide_rs {
    my $prs = shift;

    use List::MoreUtils qw(uniq);

    local $, = " ";
    foreach my $peptide ($prs->all) {
        say $peptide->sequence;
        say uniq( map { $_->type } $peptide->proteins );
        say uniq( map { $_->species } $peptide->proteins );
        say '-' x 80;
    }

}

__END__

=head1 1b4e9

Get peptides that satisfy 1b4e9 reactivity characterization (Rumbo et. al 2000)

=head1 SYNOPSIS

1b4e9 --db=database.sqlite --output=output.sqlite

Options:
    -help    brief help message
